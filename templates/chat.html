<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Policy Insight Chatbot</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .chat-container {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
      }
      .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        max-width: 85%;
      }
      .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
      }
      .bot-message {
        background-color: white;
        border: 1px solid #dee2e6;
        margin-right: auto;
      }
      .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
      }
      .suggestion-list {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
        padding: 1rem;
        border-radius: 0.375rem;
        margin-top: 0.5rem;
      }
      .loading-spinner {
        display: none;
        text-align: center;
        padding: 1rem;
      }
      .navbar {
        background-color: #343a40 !important;
      }
      .navbar-brand {
        color: white !important;
        font-weight: bold;
      }
      .nav-link {
        color: #adb5bd !important;
      }
      .nav-link:hover {
        color: white !important;
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-shield-alt"></i> Policy Chatbot Test Interface
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="fas fa-home"></i> Home
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/chat">
                <i class="fas fa-comments"></i> Chat
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/login">
                <i class="fas fa-sign-in-alt"></i> Login
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row">
        <div class="col-md-8 mx-auto">
          <div class="text-center mb-4">
            <h2><i class="fas fa-robot"></i> Policy Insight Chatbot</h2>
            <p class="text-muted">
              Ask questions about privacy policies, terms of service, and data protection
            </p>
          </div>

          <div class="chat-container" id="chat-container">
            <div id="chat-messages">
              <div class="message bot-message">
                <p>
                  <strong><i class="fas fa-robot"></i> Assistant:</strong>
                </p>
                <p>
                  Welcome! I can answer general questions about policies, or you can provide a URL below to ask questions about a specific page.
                </p>
                <p><strong>Try asking:</strong></p>
                <ul>
                  <li>"What personal data do websites typically collect?"</li>
                  <li>"What are my privacy rights?"</li>
                </ul>
              </div>
            </div>
            <div class="loading-spinner" id="loading-spinner">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Thinking...</p>
            </div>
          </div>

          <form id="chat-form" class="mt-3">
            <!-- NEW URL INPUT FIELD -->
            <div class="input-group mb-3">
              <span class="input-group-text" id="url-addon"><i class="fas fa-link"></i></span>
              <input type="url" class="form-control" id="url-input" name="url" placeholder="Enter URL of a policy page to analyze (optional)">
            </div>
            
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="query"
                name="query"
                placeholder="Ask your question here..."
                required
              />
              <button type="submit" class="btn btn-primary" id="send-btn">
                <i class="fas fa-paper-plane"></i> Send
              </button>
            </div>
          </form>

          <div class="mt-4" id="feedback-section" style="display: none">
            <div class="card">
              <div class="card-header">
                <h5><i class="fas fa-comment"></i> Feedback</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="feedback-score" class="form-label"
                    >Rate this response:</label
                  >
                  <select class="form-select" id="feedback-score" name="score">
                    <option value="">Select rating...</option>
                    <option value="5">⭐⭐⭐⭐⭐ Excellent</option>
                    <option value="4">⭐⭐⭐⭐ Good</option>
                    <option value="3">⭐⭐⭐ Average</option>
                    <option value="2">⭐⭐ Poor</option>
                    <option value="1">⭐ Very Poor</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="feedback-comment" class="form-label"
                    >Comment (optional):</label
                  >
                  <textarea
                    class="form-control"
                    id="feedback-comment"
                    name="comment"
                    placeholder="What could be improved?"
                  ></textarea>
                </div>
                <input type="hidden" id="response-id" name="response_id" />
                <button id="submit-feedback" class="btn btn-outline-primary">
                  <i class="fas fa-thumbs-up"></i> Submit Feedback
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentResponseId = "";

      document
        .getElementById("chat-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const query = document.getElementById("query").value;
          const url = document.getElementById("url-input").value; // Get URL value
          const sendBtn = document.getElementById("send-btn");
          const loadingSpinner = document.getElementById("loading-spinner");
          const chatMessages = document.getElementById("chat-messages");

          // Hide feedback section for new query
          document.getElementById("feedback-section").style.display = "none";
          document.getElementById("feedback-score").value = "";
          document.getElementById("feedback-comment").value = "";

          // Show loading state
          sendBtn.disabled = true;
          sendBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Thinking...';
          loadingSpinner.style.display = "block";

          // Add user message
          const userMessage = document.createElement("div");
          userMessage.className = "message user-message";
          userMessage.innerHTML = `<p><strong><i class="fas fa-user"></i> You:</strong> ${query}</p>`;
          chatMessages.appendChild(userMessage);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          try {
            // UPDATED: Use URLSearchParams to send both query and url
            const formData = new URLSearchParams();
            formData.append('query', query);
            if (url) {
                formData.append('url', url);
            }

            const response = await fetch("/chat", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: formData,
            });

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({error: `HTTP ${response.status}: ${response.statusText}`}));
              throw new Error(errorData.error || `HTTP ${response.status}`);
            }

            const data = await response.json();
            console.log("Response data:", data);

            if (data.error) {
              // Handle errors
              const errorDiv = document.createElement("div");
              errorDiv.className = "message bot-message";
              
              let errorHtml = `
                <p><strong><i class="fas fa-robot"></i> Assistant:</strong></p>
                <div class="error-message">
                  <i class="fas fa-exclamation-triangle"></i> ${data.error}
                </div>
              `;
              errorDiv.innerHTML = errorHtml;
              chatMessages.appendChild(errorDiv);
            } else {
              // Handle successful response
              const botMessage = document.createElement("div");
              botMessage.className = "message bot-message";
              
              // Add the timer to the response
              let timerHtml = '';
              if (data.duration) {
                  timerHtml = `<p class="text-muted small mt-2 mb-0" style="text-align: right;">
                                 <i class="fas fa-clock"></i> Processed in ${data.duration} seconds
                               </p>`;
              }

              botMessage.innerHTML = `
                <p><strong><i class="fas fa-robot"></i> Assistant:</strong></p>
                <div>${data.response}</div>
                ${timerHtml}
              `;

              chatMessages.appendChild(botMessage);

              // Show feedback section and store response ID
              if (data.response_id) {
                currentResponseId = data.response_id;
                document.getElementById("response-id").value = currentResponseId;
                document.getElementById("feedback-section").style.display = "block";
              }
            }

            // Clear form
            document.getElementById("query").value = "";
            // Optionally clear the URL field after each request
            // document.getElementById("url-input").value = ""; 
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
          } catch (error) {
            console.error("Error:", error);
            const errorDiv = document.createElement("div");
            errorDiv.className = "message bot-message";
            errorDiv.innerHTML = `
              <p><strong><i class="fas fa-robot"></i> Assistant:</strong></p>
              <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i> ${error.message}
              </div>
            `;
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
          } finally {
            // Reset button state
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
            loadingSpinner.style.display = "none";
          }
        });

      document
        .getElementById("submit-feedback")
        .addEventListener("click", async () => {
          const score = document.getElementById("feedback-score").value;
          const comment = document.getElementById("feedback-comment").value;
          const responseId = document.getElementById("response-id").value;

          if (!score || !responseId) {
            alert("Please select a rating and ensure a response is available.");
            return;
          }

          try {
            const response = await fetch("/feedback", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: `score=${encodeURIComponent(
                score
              )}&comment=${encodeURIComponent(
                comment
              )}&response_id=${encodeURIComponent(responseId)}`,
            });

            const data = await response.json();

            if (data.error) {
              alert(data.error);
            } else {
              alert("✅ Thank you for your feedback!");
              document.getElementById("feedback-score").value = "";
              document.getElementById("feedback-comment").value = "";
              document.getElementById("feedback-section").style.display = "none";
            }
          } catch (error) {
            console.error("Feedback error:", error);
            alert("Error submitting feedback. Please try again.");
          }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>